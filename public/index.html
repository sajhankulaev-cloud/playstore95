<!doctype html><html lang="ru"><head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700;800&display=swap" rel="stylesheet">
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PlayStore 95 — Скидки</title><link rel="stylesheet" href="/styles.css"/></head>
<body>
<div class="topbar"><div class="container">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div class="brand">PlayStore 95</div><div class="badge" id="updated"></div>
  </div>
  <div class="filters">
    <select id="region" class="select"><option value="TR">TR</option><option value="UA">UA</option></select>
    <select id="sort" class="select"><option value="pop">Цена: По умолчанию</option><option value="price_asc">Цена: по возрастанию</option><option value="price_desc">Цена: по убыванию</option></select>
    <select id="platform" class="select"><option value="">PS4/PS5</option><option value="PS4">PS4</option><option value="PS5">PS5</option></select>
    <input id="search" class="input" style="min-width:240px" placeholder="Поиск по названию"/>
    <button id="reset" class="btnGhost" type="button">Сброс</button>
    <button id="apply" class="buyBtn" style="background:#fff;"></button>
  </div>
</div></div>

<div class="container">
  <div id="emptyBox" class="card" style="display:none;padding:12px;margin-top:14px;">
    Игры еще не добавлены
  </div>
  <div class="grid" id="grid"></div>
  <div class="pager" id="pager"></div>
</div>

<script>
const state={region:"TR",sort:"pop",platform:"",page:1,search:""};
// restore state from URL query (shareable links)
const urlQS=new URLSearchParams(location.search);
if(urlQS.get("region")) state.region=urlQS.get("region");
if(urlQS.get("page")) state.page=Math.max(1, parseInt(urlQS.get("page"),10)||1);
if(urlQS.get("sort")) state.sort=urlQS.get("sort");
if(urlQS.get("platform")) state.platform=urlQS.get("platform");
if(urlQS.get("q")) state.search=urlQS.get("q");

// restore last selected region on refresh

try{
  const savedRegion = localStorage.getItem("ps95_region");
  if(savedRegion && !urlQS.get("region")) state.region = savedRegion;
}catch(e){}

function fmtRub(n){try{return new Intl.NumberFormat("ru-RU").format(n)+" ₽";}catch(e){return n+" ₽";}}
function buildCard(game, whatsapp, showUntil){
  const div=document.createElement("div");div.className="card";
  const until = (showUntil && game.discountedUntil) ? ("До: "+game.discountedUntil) : "";
  div.innerHTML=`
    <div class="coverWrap">
      <div class="platformStrip">${game.platform||"PS4 / PS5"}</div>
      ${game.cover?`<img src="${game.cover}" alt="" referrerpolicy="no-referrer" onerror="this.style.display='none'">`:"<div style='font-weight:900;font-size:12px;opacity:.9'>NO COVER</div>"}
    </div>
    <div class="body">
      <p class="title">${game.name||""}</p>
      <div class="bottom">
      <div class="row"><div class="discount">${game.discPerc?("-"+game.discPerc+"%"):""}</div><div class="until">${until}</div></div>
      <div class="row"><div class="price">${fmtRub(game.finalPriceRub)}</div><button class="buyBtn">Купить</button></div>
      </div>
    </div>`;
  div.querySelector(".buyBtn").onclick=()=>{
    const msg=encodeURIComponent(`Хочу купить игру: ${game.name}\nРегион: ${state.region}\nЦена: ${fmtRub(game.finalPriceRub)}`);
    const base=whatsapp||"https://wa.me/+79659556300";
    window.open(base+(base.includes("?")?"&":"?")+"text="+msg,"_blank");
  };
  return div;
}
async function load(){
  // keep filters selected across pagination
  document.getElementById("region").value=state.region;
  document.getElementById("sort").value=state.sort;
  if(document.getElementById("platform")) document.getElementById("platform").value=state.platform||"";
  document.getElementById("search").value=state.search||"";
  const meta=await fetch("/api/meta").then(r=>r.json());
  const whatsapp=meta.settings?.whatsappLink||"https://wa.me/+79659556300";
  document.getElementById("updated").textContent="Обновление: "+(meta.updatedAt?.games||"—");
  const showUntil=!!(meta.hasAnyUntil && meta.hasAnyUntil[state.region]);

  const qs=new URLSearchParams({region:state.region,page:String(state.page),sort:state.sort});
  // keep current state in URL (so refresh keeps page/filters)
  
  if(state.platform) qs.set("platform", state.platform);
  if(state.search)qs.set("q",state.search);
  // keep current state in URL (so refresh keeps page/filters)
  try{history.replaceState(null,"",`?${qs.toString()}`);}catch(_){}
  const j=await fetch("/api/games?"+qs.toString()).then(r=>r.json());

  // If user switched region and current page became empty, jump to last available page
  if(j && (j.total||0)>0 && (j.items||[]).length===0 && state.page>1){
    const lastPage=Math.max(1, Math.ceil((j.total||0)/(j.perPage||36)));
    if(lastPage!==state.page){ state.page=lastPage; return load(); }
  }

  const grid=document.getElementById("grid");grid.innerHTML="";
  (j.items||[]).forEach(g=>grid.appendChild(buildCard(g,whatsapp,showUntil)));
  document.getElementById("emptyBox").style.display = (j.total===0) ? "block" : "none";

  const pager=document.getElementById("pager");pager.innerHTML="";
  const mk=(label,page,disabled=false)=>{const b=document.createElement("button");b.textContent=label;b.disabled=disabled;b.onclick=()=>{state.page=page;load();scrollTo(0,0)};return b;};
  pager.appendChild(mk("«",Math.max(1,state.page-1),state.page===1));
  pager.appendChild(mk(String(state.page),state.page,true));
  pager.appendChild(mk("»",state.page+1,false));
}
document.getElementById("region").onchange=e=>{state.region=e.target.value;try{localStorage.setItem("ps95_region",state.region);}catch(_){};load();};
document.getElementById("sort").onchange=e=>{state.sort=e.target.value;state.page=1;load();};
document.getElementById("apply").onclick=()=>{
  state.region=document.getElementById("region").value;
  state.sort=document.getElementById("sort").value;
  state.platform=document.getElementById("platform").value;
  state.search=(document.getElementById("search").value||"").trim();
  state.page=1;
  load();
};
let __searchTimer=null;
document.getElementById("search").addEventListener("input",()=>{
  state.search=(document.getElementById("search").value||"");
  state.page=1;
  clearTimeout(__searchTimer);
  __searchTimer=setTimeout(()=>load(),250);
});

document.getElementById("platform").onchange=()=>{state.platform=document.getElementById("platform").value;state.page=1;load();};
document.getElementById("sort").onchange=()=>{state.sort=document.getElementById("sort").value;state.page=1;load();};

document.getElementById("reset").onclick=()=>{
  state.search="";
  state.platform="";
  state.sort="pop";
  state.page=1;
  document.getElementById("search").value="";
  document.getElementById("platform").value="";
  document.getElementById("sort").value="pop";
  load();
};

load();
</script></body></html>
