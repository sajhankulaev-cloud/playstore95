<!doctype html><html lang="ru"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PlayStore 95 ‚Äî Admin</title><link rel="stylesheet" href="/styles.css"/>
<style>
body{background:#f3f5f7;color:#0f172a;}
.small{color:#475569;}
.select,input,textarea{
  background:#fff;
  color:#0f172a;
  border:1px solid #cbd5e1;
}
.select:focus,input:focus,textarea:focus{
  outline:none;
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.15);
}
button{
  color:#0f172a;
}
</style>



<style>
/* === ADMIN FIX v3: readable light admin (only admin page) === */
:root{ color-scheme: light; }
html, body{
  background:#f3f5f7 !important;
  color:#0f172a !important;
}

/* prevent washed-out text from inherited opacity/filters */
body, body *{
  opacity:1 !important;
  filter:none !important;
  text-shadow:none !important;
}

/* typography */
h1,h2,h3,h4,h5{ color:#0f172a !important; }
.small{ color:#475569 !important; }
a{ color:#1d4ed8 !important; }

/* cards/blocks */
.card, .box, .panel{
  background:#ffffff !important;
  border-color:#cbd5e1 !important;
}

/* tables */
table{ background:#ffffff !important; }
th, td{ color:#0f172a !important; }
thead th{
  background:#f8fafc !important;
  color:#0f172a !important;
}
tbody tr{ background:#ffffff !important; }
tbody tr:nth-child(even){ background:#f8fafc !important; }

/* inputs */
input,select,textarea{
  background:#ffffff !important;
  color:#0f172a !important;
  border:1px solid #cbd5e1 !important;
}
input::placeholder, textarea::placeholder{
  color:#64748b !important;   /* darker placeholder */
  opacity:1 !important;
}
/* some inputs may use value styling via -webkit-text-fill-color */
input{
  -webkit-text-fill-color:#0f172a !important;
}
input:disabled, select:disabled, textarea:disabled{
  background:#f1f5f9 !important;
  color:#334155 !important;
  -webkit-text-fill-color:#334155 !important;
}

/* focus */
input:focus,select:focus,textarea:focus{
  outline:none !important;
  border-color:#3b82f6 !important;
  box-shadow:0 0 0 3px rgba(59,130,246,.15) !important;
}

/* buttons */
button{ color:#0f172a !important; }
.btnGhost{
  background:#ffffff !important;
  color:#0f172a !important;
  border:1px solid #cbd5e1 !important;
}
.btnGhost:hover{ background:#f1f5f9 !important; }

/* primary dark button */
.btnDark{ color:#ffffff !important; }
</style>

</head>

<body><div class="layout">
<aside class="side"><h2>PlayStore 95 ‚Äî Admin</h2>
<div class="nav">
  <a class="active" href="#import">–ò–º–ø–æ—Ä—Ç</a>
  <a href="#games">–ò–≥—Ä—ã</a>
  <a href="#rates">–ö—É—Ä—Å—ã</a>
  <a href="#settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
  <a href="/" target="_blank">–ö–∞—Ç–∞–ª–æ–≥</a>
</div>
<div style="margin-top:18px;font-size:12px;color:#9ca3af;line-height:1.4">–î–æ—Å—Ç—É–ø –∑–∞—â–∏—â—ë–Ω Basic Auth.<br/>–õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ <b>.env</b></div></aside>

<main class="main">

<div class="adminCard" id="import">
  <div style="font-weight:950;font-size:16px;">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É –ø–æ —Å—Å—ã–ª–∫–µ (PS Store)</div>
  <div class="small">–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä—ã PS Store (—Å <b>/product/...</b>). –ò–º–ø–æ—Ä—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –≤–∑—è—Ç—å: –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–±–ª–æ–∂–∫—É, —Å–∫–∏–¥–∫—É%, –¥–∞—Ç—É –∫–æ–Ω—Ü–∞, —Ü–µ–Ω—É.</div>
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;align-items:flex-end;">
    <div style="flex:1;min-width:280px;">
      <div class="small">–°—Å—ã–ª–∫–∞</div>
      <input id="importUrl" class="input" type="text" placeholder="https://store.playstation.com/.../product/EP..." />
    </div>
    <div style="min-width:200px;">
      <div class="small">–î–∞—Ç–∞ —Å–∫–∏–¥–∫–∏ (–≤—Ä—É—á–Ω—É—é)</div>
      <input id="manualUntil" class="input" type="date" /> <span id="manualUntilPreview" class="small" style="margin-left:10px; opacity:.85;"></span>
    </div>
    <div><button class="btnDark" id="btnImport">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>
  </div>

  <div id="importResult" style="display:none;margin-top:12px;">
    <div class="small" id="importHttp"></div>
    <div class="small">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–º–æ–∂–Ω–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å):</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;">
      <div style="width:140px;">
        <div class="coverWrap" style="border-radius:12px;">
          <img id="impCover" src="" alt="" referrerpolicy="no-referrer" style="display:none"/>
          <div id="impNoCover" style="font-weight:900;font-size:12px;opacity:.9">NO COVER</div>
        </div>
      </div>
      <div style="flex:1;max-width:500px;">
        <div class="small">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
        <input id="impName" class="input" type="text" />
        <div class="small" style="margin-top:8px;">Edition</div>
        <input id="impEdition" class="input" type="text" placeholder="Standard / Deluxe / Premium..." />

        <div class="small" style="margin-top:8px;">–†—É—Å—Å–∫–∏–π —è–∑—ã–∫</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;">
          <div style="flex:1;min-width:180px;">
            <div class="small">–†—É—Å—Å–∫–∏–π (TR)</div>
            <select id="impRuTR" class="select" style="width:100%;">
              <option value="none" selected>üá∑üá∫ –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
              <option value="text">üá∑üá∫ –¢–µ–∫—Å—Ç</option>
              <option value="voice">üá∑üá∫ –û–∑–≤—É—á–∫–∞</option>
            </select>
          </div>
          <div style="flex:1;min-width:180px;">
            <div class="small">–†—É—Å—Å–∫–∏–π (UA)</div>
            <select id="impRuUA" class="select" style="width:100%;">
              <option value="none" selected>üá∑üá∫ –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
              <option value="text">üá∑üá∫ –¢–µ–∫—Å—Ç</option>
              <option value="voice">üá∑üá∫ –û–∑–≤—É—á–∫–∞</option>
            </select>
          </div>
        </div>

        <div class="small" style="margin-top:10px;">–ü–æ–¥–ø–∏—Å–∫–∞ (TR)</div>
        <select id="impSubTR" class="select" style="width:100%;">
          <option value="" selected>‚Äî</option>
          <option value="psplus_extra">PS Plus Extra</option>
          <option value="eaplay">EA Play</option>
        </select>


<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;">
          <div style="flex:1;min-width:180px;">
            <div class="small">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
            <select id="impPlatform" class="select" style="width:100%;">
              <option value="PS4 / PS5">PS4 / PS5</option>
              <option value="PS5">PS5</option>
              <option value="PS4">PS4</option>
            </select>
          </div>
          <div style="flex:1;min-width:180px;">
            <div class="small">ID (product)</div>
            <input id="impId" class="input" type="text" />
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
          <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;">
            <div style="font-weight:900;">TR</div>
            <div class="small">–¶–µ–Ω–∞ (TL)</div>
<input id="impTrPrice" class="input" type="number" step="0.01"/>
            <div class="small" style="margin-top:8px;">–°–∫–∏–¥–∫–∞ %</div><input id="impTrDisc" class="input" type="number" step="1"/>
            <div class="small" style="margin-top:8px;">–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞</div><input id="impTrUntil" class="input" type="text" placeholder="YYYY-MM-DD"/>
          </div>
          <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;">
            <div style="font-weight:900;">UA</div>
            <div class="small">–¶–µ–Ω–∞</div>
<input id="impUaPrice" class="input" type="number" step="0.01"/>
            <div class="small" style="margin-top:8px;">–°–∫–∏–¥–∫–∞ %</div><input id="impUaDisc" class="input" type="number" step="1"/>
            <div class="small" style="margin-top:8px;">–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞</div><input id="impUaUntil" class="input" type="text" placeholder="YYYY-MM-DD"/>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
          <button class="btnDark" id="btnAddGame">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Å–∞–π—Ç</button>
          <span class="small" id="importStatus"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="adminCard" id="games">
  <div style="font-weight:950;font-size:16px;">–ò–≥—Ä—ã –Ω–∞ —Å–∞–π—Ç–µ</div>
  <div class="small">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–≥—Ä –ø–æ –¥–∞—Ç–µ —Å–∫–∏–¥–∫–∏.</div>
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;align-items:center;">
    <input id="gamesSearch" class="input" style="min-width:260px" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é"/>
    <button class="btnGhost" id="refreshGames">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <span class="small" id="gamesCount"></span>
  </div>
  <div id="gamesGroups" style="margin-top:12px;"></div>
</div>

<div class="adminCard" id="rates">
<div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
<div><div style="font-weight:950;font-size:16px;">–ö—É—Ä—Å—ã –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º</div><div class="small">TR/UA ‚Ä¢ –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö.</div></div>
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
<select id="regionSel" class="select"><option value="TR">–¢—É—Ä—Ü–∏—è (TR)</option><option value="UA">–£–∫—Ä–∞–∏–Ω–∞ (UA)</option></select>
<button class="btnGhost" id="addRow">+ –î–∏–∞–ø–∞–∑–æ–Ω</button><button class="btnDark" id="saveRates">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div></div>
<div style="margin-top:12px;overflow:auto;">
<table><thead><tr><th>–û—Ç</th><th>–î–æ</th><th>–ö—É—Ä—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody id="ratesBody"></tbody></table></div></div>

<div class="adminCard" id="settings"><div style="font-weight:950;font-size:16px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
<div class="small">WhatsApp —Å—Å—ã–ª–∫–∞ –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ.</div>
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;">
<div style="flex:1;min-width:220px;"><div class="small">–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ</div>
<select id="roundStep" class="selecColor" style="width:100%;"><option value="50">–¥–æ 50 ‚ÇΩ (–≤–≤–µ—Ä—Ö)</option><option value="100">–¥–æ 100 ‚ÇΩ (–≤–≤–µ—Ä—Ö)</option></select></div>
<div style="flex:2;min-width:260px;"><div class="small">WhatsApp —Å—Å—ã–ª–∫–∞</div><input id="wa" class="input" type="text" placeholder="https://wa.me/..."/></div>
<div style="align-self:flex-end;"><button class="btnDark" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
</div></div>

</main></div>

<script>
  // --- Persist "manualUntil" date (localStorage + server settings.defaultDiscountUntil) ---
  const LS_KEY_UNTIL = "ps95_manualUntil_iso"; // yyyy-mm-dd

  const RU_MONTHS = ["—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è","–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"];
  function formatRuDate(iso){
    if(!iso) return "";
    // expects yyyy-mm-dd
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return iso;
    const y = Number(m[1]);
    const mon = Number(m[2]);
    const d = Number(m[3]);
    if(!(y && mon>=1 && mon<=12 && d>=1 && d<=31)) return iso;
    return `${d} ${RU_MONTHS[mon-1]} ${y}`;
  }

  function updateUntilPreview(){
    const el = document.getElementById("manualUntil");
    const pv = document.getElementById("manualUntilPreview");
    if(!pv) return;
    const iso = (el && el.value) ? el.value.trim() : "";
    pv.textContent = iso ? ("–î–∞—Ç–∞ —Å–∫–∏–¥–∫–∏: " + formatRuDate(iso)) : "";
  }

  async function loadUntil(){
    const el = document.getElementById("manualUntil");
    if(!el) return;

    // 1) load instantly from localStorage so it never resets on refresh
    const cached = localStorage.getItem(LS_KEY_UNTIL);
    if(cached && !el.value){
      el.value = cached;
    }
    updateUntilPreview();

    // 2) try server settings (best-effort)
    try{
      const r = await fetch("/api/admin/settings", { credentials: "include" });
      const j = await r.json().catch(()=>null);
      if(r.ok && j && j.ok){
        const v = (j.settings && j.settings.defaultDiscountUntil) ? String(j.settings.defaultDiscountUntil) : "";
        if(v){
          el.value = v;
          localStorage.setItem(LS_KEY_UNTIL, v);
        }
      }
    }catch(e){}
    updateUntilPreview();
  }

  async function saveUntil(){
    const el = document.getElementById("manualUntil");
    if(!el) return;
    const v = (el.value || "").trim(); // yyyy-mm-dd

    // always store locally
    if(v) localStorage.setItem(LS_KEY_UNTIL, v);
    else localStorage.removeItem(LS_KEY_UNTIL);

    updateUntilPreview();

    // save to server (best-effort)
    try{
      await fetch("/api/admin/settings", {
        method:"POST",
        credentials:"include",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ defaultDiscountUntil: v })
      });
    }catch(e){}
  }


  // --- Persist default discount date in store.json (server-side) ---
  async function loadSettings(){
    try{
      const r = await fetch("/api/admin/settings");
      const j = await r.json();
      if(!r.ok || !j.ok) return;
      if(typeof j.settings?.defaultDiscountUntil !== "undefined"){
        const el = document.getElementById("defaultDiscountUntil");
        if(el){
          el.value = j.settings.defaultDiscountUntil || "";
        }
      }
    }catch(e){}
  }

  async function saveDefaultDate(){
    const el = document.getElementById("defaultDiscountUntil");
    if(!el) return;
    try{
      await fetch("/api/admin/settings", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ defaultDiscountUntil: (el.value||"").trim() })
      });
    }catch(e){}
  }


function rowTemplate(min="", max="", rate=""){const tr=document.createElement("tr");
tr.innerHTML=`<td><input class="input" type="number" step="1" value="${min}"></td>
<td><input class="input" type="number" step="1" value="${max}"></td>
<td><input class="input" type="number" step="0.01" value="${rate}"></td>
<td><button class="btnGhost">–£–¥–∞–ª–∏—Ç—å</button></td>`;
tr.querySelector("button").onclick=()=>tr.remove();return tr;}

async function loadRates(region){const j=await fetch(`/api/admin/rates?region=${region}`).then(r=>r.json());
const body=document.getElementById("ratesBody");body.innerHTML="";(j.rules||[]).forEach(rule=>body.appendChild(rowTemplate(rule.min, rule.max??"", rule.rate)));}
async function saveRates(){const region=document.getElementById("regionSel").value;
const rules=[...document.querySelectorAll("#ratesBody tr")].map(tr=>{const i=tr.querySelectorAll("input");
const min=Number(i[0].value);const maxRaw=i[1].value.trim();const max=maxRaw===""?null:Number(maxRaw);const rate=Number(i[2].value);return {min,max,rate};});
const j=await fetch(`/api/admin/rates`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({region,rules})}).then(r=>r.json());
alert(j.ok?"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ":"–û—à–∏–±–∫–∞");}
async function loadSettings(){const j=await fetch(`/api/admin/settings`).then(r=>r.json());
document.getElementById("roundStep").value=String(j.roundStep||50);document.getElementById("wa").value=j.whatsappLink||"";}
async function saveSettings(){const roundStep=document.getElementById("roundStep").value;
const whatsappLink=document.getElementById("wa").value.trim();
const j=await fetch(`/api/admin/settings`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({roundStep,whatsappLink})}).then(r=>r.json());
alert(j.ok?"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ":"–û—à–∏–±–∫–∞");}

async function loadGamesList(){
  const j=await fetch("/api/admin/games/list").then(r=>r.json());
  window.__games = (j.items||[]);
  document.getElementById("gamesCount").textContent = "–í—Å–µ–≥–æ: " + window.__games.length;
  renderGames();
}
function renderGames(){
  const q=(document.getElementById("gamesSearch").value||"").trim().toLowerCase();
  const wrap=document.getElementById("gamesGroups");
  wrap.innerHTML="";

  const rows=(window.__games||[]).filter(g=>!q || String(g.name||"").toLowerCase().includes(q));

  // Sort by discount date (soonest first). Null dates go last.
  const toKey = (iso) => {
    if(!iso) return null;
    const m = String(iso).trim().match(/^\d{4}-\d{2}-\d{2}$/);
    return m ? iso : null;
  };
  rows.sort((a,b)=>{
    const da = toKey(a.discountedUntil);
    const db = toKey(b.discountedUntil);
    if(!da && !db) return String(a.name||"").localeCompare(String(b.name||""));
    if(!da) return 1;
    if(!db) return -1;
    if(da === db) return String(a.name||"").localeCompare(String(b.name||""));
    return da.localeCompare(db); // YYYY-MM-DD lex order works
  });

  // Group by date
  const groups = new Map();
  for(const g of rows){
    const k = toKey(g.discountedUntil) || "__NO_DATE__";
    if(!groups.has(k)) groups.set(k, []);
    groups.get(k).push(g);
  }

  const groupKeys = [...groups.keys()].sort((a,b)=>{
    if(a === "__NO_DATE__" && b === "__NO_DATE__") return 0;
    if(a === "__NO_DATE__") return 1;
    if(b === "__NO_DATE__") return -1;
    return a.localeCompare(b);
  });

  if(!groupKeys.length){
    wrap.innerHTML = `<div class="small" style="opacity:.85;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`;
    return;
  }

  for(const k of groupKeys){
    const list = groups.get(k) || [];
    const title = (k === "__NO_DATE__") ? "–ë–µ–∑ –¥–∞—Ç—ã —Å–∫–∏–¥–∫–∏" : ("–°–∫–∏–¥–∫–∞ –¥–æ: " + formatRuDate(k));

    const card = document.createElement("div");
    card.className = "groupCard";
    card.innerHTML = `
      <div class="groupHead">
        <div>
          <div class="groupTitle">${title}</div>
          <div class="small" style="opacity:.85;">–ò–≥—Ä—ã: ${list.length}</div>
        </div>
        <button class="btnDanger" data-date="${k}">–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;

    const tbody = card.querySelector("tbody");
    for(const g of list){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${g.id}</td><td>${g.name||""}</td><td>${g.platform||""}</td><td><button class="btnGhost">–£–¥–∞–ª–∏—Ç—å</button></td>`;
      tr.querySelector("button").onclick=async ()=>{
        if(!confirm(`–£–¥–∞–ª–∏—Ç—å "${g.name}"?`)) return;
        const resp=await fetch("/api/admin/games/"+encodeURIComponent(g.id), {method:"DELETE"});
        const jj=await resp.json();
        if(jj.ok){ await loadGamesList(); }
        else alert("–û—à–∏–±–∫–∞: "+(jj.error||""));
      };
      tbody.appendChild(tr);
    }

    const delBtn = card.querySelector("button.btnDanger");
    delBtn.onclick = async ()=>{
      const dateKey = delBtn.getAttribute("data-date");
      const human = (dateKey === "__NO_DATE__") ? "–±–µ–∑ –¥–∞—Ç—ã" : formatRuDate(dateKey);
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å –í–°–ï –∏–≥—Ä—ã –≤ –±–ª–æ–∫–µ (${human})?`)) return;
      delBtn.disabled = true;
      try{
        const qp = dateKey === "__NO_DATE__" ? "none" : dateKey;
        const r = await fetch(`/api/admin/games/by-discount-date?date=${encodeURIComponent(qp)}`, { method: "DELETE" });
        const j = await r.json().catch(()=>({ok:false,error:"bad json"}));
        if(j.ok){
          await loadGamesList();
        }else{
          alert("–û—à–∏–±–∫–∞: " + (j.error || r.status));
        }
      }catch(e){
        alert("–û—à–∏–±–∫–∞: " + String(e));
      }finally{
        delBtn.disabled = false;
      }
    };

    wrap.appendChild(card);
  }
}
document.getElementById("gamesSearch").addEventListener("input", renderGames);
document.getElementById("refreshGames").onclick=loadGamesList;

async function doImport(){
  const url=document.getElementById("importUrl").value.trim();
  if(!url){alert("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É");return;}
  document.getElementById("importStatus").textContent="–ò–º–ø–æ—Ä—Ç...";
  const j=await fetch("/api/admin/import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url})}).then(r=>r.json());
  if(!j.ok){document.getElementById("importStatus").textContent="–û—à–∏–±–∫–∞: "+(j.error||"");return;}
  document.getElementById("importHttp").textContent = `HTTP TR:${j.status.TR} UA:${j.status.UA}`;
  if(j.parsed?.TR?.blocked || j.parsed?.UA?.blocked){alert("PS Store –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –∏–º–ø–æ—Ä—Ç (captcha/blocked). –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π VPN/—Å–µ—Ä–≤–µ—Ä.");}

  const pid=j.productId||"";
  const name=(j.parsed?.TR?.name)|| (j.parsed?.UA?.name)|| "";
  const cover=(j.parsed?.TR?.cover)|| (j.parsed?.UA?.cover)|| "";
  document.getElementById("impId").value=pid;
  document.getElementById("impName").value=name||"";
    const tr = j.parsed?.TR || {};
    const ua = j.parsed?.UA || {};
    const ed = (tr.edition || ua.edition || "Standard Edition");
    const edEl = document.getElementById("impEdition");
    if(edEl) edEl.value = ed;
    const ruTR = (tr.ru || "none");
  const ruUA = (ua.ru || "none");
  const ruTrEl = document.getElementById("impRuTR");
  const ruUaEl = document.getElementById("impRuUA");
  if(ruTrEl) ruTrEl.value = ruTR;
  if(ruUaEl) ruUaEl.value = ruUA;

  const subTR = (tr.sub || "");
  const subTrEl = document.getElementById("impSubTR");
  if(subTrEl) subTrEl.value = subTR;
if(ruTrEl) ruTrEl.value = ruTR;
  if(ruUaEl) ruUaEl.value = ruUA;
if(cover){
    document.getElementById("impCover").src=cover;
    document.getElementById("impCover").style.display="block";
    document.getElementById("impNoCover").style.display="none";
  }else{
    document.getElementById("impCover").style.display="none";
    document.getElementById("impNoCover").style.display="block";
  }
  document.getElementById("impTrPrice").value=j.parsed?.TR?.salePrice ?? "";
  document.getElementById("impUaPrice").value=j.parsed?.UA?.salePrice ?? "";
  document.getElementById("impTrDisc").value=j.parsed?.TR?.discPerc ?? 0;
  document.getElementById("impUaDisc").value=j.parsed?.UA?.discPerc ?? 0;
  // –¥–∞—Ç—É —Å–æ Store –Ω–µ —Ç—è–Ω–µ–º ‚Äî —Å—Ç–∞–≤–∏–º –≤—Ä—É—á–Ω—É—é –∏–∑ –ø–æ–ª—è –≤—ã—à–µ
  document.getElementById("impTrUntil").value="";
  document.getElementById("impUaUntil").value="";
  const manualUntil = document.getElementById("manualUntil")?.value || "";
  if(manualUntil){
    document.getElementById("impTrUntil").value = manualUntil;
    document.getElementById("impUaUntil").value = manualUntil;
  }
  document.getElementById("importResult").style.display="block";
  document.getElementById("importStatus").textContent="–ì–æ—Ç–æ–≤–æ. –ü—Ä–æ–≤–µ—Ä—å –∏ –Ω–∞–∂–º–∏ '–î–æ–±–∞–≤–∏—Ç—å'.";
}

async function addGame(){
  const manualUntil = document.getElementById("manualUntil")?.value || "";
  if(manualUntil){
    if(!document.getElementById("impTrUntil").value) document.getElementById("impTrUntil").value = manualUntil;
    if(!document.getElementById("impUaUntil").value) document.getElementById("impUaUntil").value = manualUntil;
  }
  const g={
    id: document.getElementById("impId").value.trim(),
    name: document.getElementById("impName").value.trim(),
    cover: document.getElementById("impCover").style.display==="block" ? document.getElementById("impCover").src : null,
    platform: document.getElementById("impPlatform").value,
    edition: (document.getElementById("impEdition")?.value || "").trim() || "Standard Edition",
    regions:{
      TR:{
        salePrice:Number(document.getElementById("impTrPrice").value||0),
        discPerc:Number(document.getElementById("impTrDisc").value||0),
        discountedUntil: (document.getElementById("impTrUntil").value.trim()||null),
        ru: (document.getElementById("impRuTR")?.value || "none"),
        sub: (document.getElementById("impSubTR")?.value || "")
      },
      UA:{
        salePrice:Number(document.getElementById("impUaPrice").value||0),
        discPerc:Number(document.getElementById("impUaDisc").value||0),
        discountedUntil: (document.getElementById("impUaUntil").value.trim()||null),
        ru: (document.getElementById("impRuUA")?.value || "none"),
        sub: ""
      }
    }
  };
  document.getElementById("importStatus").textContent="–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...";
  const j=await fetch(`/api/admin/games/add`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}).then(r=>r.json());
  if(j.ok){
    document.getElementById("importStatus").textContent="–î–æ–±–∞–≤–ª–µ–Ω–æ. –í—Å–µ–≥–æ –∏–≥—Ä: "+j.count;
    await loadGamesList();
  }else{
    document.getElementById("importStatus").textContent="–û—à–∏–±–∫–∞: "+(j.error||"");
  }
}

document.getElementById("btnImport").onclick=doImport;
document.getElementById("btnAddGame").onclick=addGame;
document.getElementById("regionSel").onchange=e=>loadRates(e.target.value);
document.getElementById("addRow").onclick=()=>document.getElementById("ratesBody").appendChild(rowTemplate());
document.getElementById("saveRates").onclick=saveRates;
document.getElementById("saveSettings").onclick=saveSettings;
loadRates("TR");loadSettings();loadGamesList();

loadUntil();

  const _mu = document.getElementById("manualUntil");
  if(_mu){
    _mu.addEventListener("change", saveUntil);
    _mu.addEventListener("blur", saveUntil);
  }
</script></body></html>
